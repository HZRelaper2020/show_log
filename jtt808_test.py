import os
import sys
import struct
import socket
import threading
import re
import time
import logging

PORT = 8837

def test_send_subpacket(sk):
    # time.sleep(0.1)
    data = [0x7e,0x7e,0x0,0x1,0x0,0x12,0x5,0x76,0x7,0x8,0x8,0xa,0xb,0xc,0xd,0xe,0x7d,0x1,0x7d,0x02,0x01,0x02,0x69,0x7e,0x7e]
    sk.send(bytes(data))

def test_send_multipacket(sk):    
    # data=[0x7e,0x12,0x34,0x00,0x64,0x01,0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x68,0x56,0x78,0x70,0x71,0x72,0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7a,0x7b,0x7c,0x7d,0x01,0x7d,0x02,0x7f,0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,0x8c,0x8d,0x8e,0x8f,0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97,0x98,0x99,0x9a,0x9b,0x9c,0x9d,0x9e,0x9f,0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xab,0xac,0xad,0xae,0xaf,0xb0,0xb1,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,0xb8,0xb9,0xba,0xbb,0xbc,0xbd,0xbe,0xbf,0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xcb,0xcc,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,0xd3,0x12,0x7e]
    
    # sk.send(bytes(data))
    # #                msgid     msgproperty  version,   mobile                                            flowid     pkgcount  pkgnumber
    # data = [0x7e,  0x00,0x01,  0x20,0x2b,   0x1,        0x17,0x31,0x84,0x53,0x26,0x80,0x0,0x0,0x0,0x0,   0x12,0x34,      0x00,0x03,   0x00,0x01,   \
    # 0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xb,0xc,0xd,0xe,0xf,0x10,0x11,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,0x1a, \
    # 0x7f,0x7e]
    # sk.send(bytes(data))
    
    # #                msgid     msgproperty  version,   mobile                                            flowid     pkgcount  pkgnumber
    # data = [0x7e,  0x00,0x01,  0x20,0x2b,   0x1,        0x17,0x31,0x84,0x53,0x26,0x80,0x0,0x0,0x0,0x0,   0x12,0x34,      0x00,0x03,   0x00,0x02,   \
    # 0x21,0x22,0x23,0x24,0x25,0x26,0x27,0x28,0x29,0x2a,0x2b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x40, \
    # 0x7f,0x7e]
    # sk.send(bytes(data))

    # #                msgid     msgproperty  version,   mobile                                            flowid     pkgcount  pkgnumber
    # data = [0x7e,  0x00,0x01,  0x20,0x2c,   0x1,        0x17,0x31,0x84,0x53,0x26,0x80,0x0,0x0,0x0,0x0,   0x12,0x34,      0x00,0x03,   0x00,0x03,   \
    # 0x7d,0x01,0x7d,0x02,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x3b,0x2c,0x2d,0x2e,0x2f,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x37,0x38,0x39,0x40, \
    # 0x7f,0x7e]
    # sk.send(bytes(data))
    fd = open("data_send.txt")
    while True:
        line = fd.readline()
        if not line:
            break
        line = line.strip()
        if line.startswith("0x7e"):
            data = []
            for unit in line.split(","):
                unit = unit.strip()
                if unit:
                    data.append(int(unit,16))
            if data:
                sk.send(bytes(data))
    fd.close()
    
def main():
    sk = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    sk.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
    ip = ("0.0.0.0",PORT)
    sk.bind(ip)
    print("listen on ",ip)
    sk.listen(100)
    
    client,addr = sk.accept()
    # print(client,addr)
    test_send_multipacket(client)
    
    client.close()
    sk.close()
    
main()